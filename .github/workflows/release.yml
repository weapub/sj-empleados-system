name: Release Frontend y Manual PDF

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Nombre del tag (e.g., v0.2.2)'
        required: true
      branch:
        description: 'Rama objetivo (e.g., main)'
        required: false
        default: 'main'

jobs:
  build_frontend:
    name: Build frontend y crear dist.zip
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
            node-version: '18'

      - name: Instalar dependencias
        working-directory: frontend
        run: |
          npm ci || npm install

      - name: Build frontend (VITE_API_URL)
        working-directory: frontend
        env:
          VITE_API_URL: https://sj-empleados-system.onrender.com
        run: |
          npm run build

      - name: Crear dist.zip
        run: |
          cd frontend/dist
          zip -r ../../dist.zip .

      - name: Upload artifact dist.zip
        uses: actions/upload-artifact@v4
        with:
          name: dist-zip
          path: dist.zip

  build_docs:
    name: Generar PDF del manual de uso
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Instalar md-to-pdf
        run: npm i -g md-to-pdf

      - name: Generar docs/manual-uso.pdf
        run: |
          md-to-pdf docs/manual-uso.md \
            --pdf-options '{"format":"A4","margin":"20mm"}' \
            --output docs/manual-uso.pdf

      - name: Upload artifact manual-uso.pdf
        uses: actions/upload-artifact@v4
        with:
          name: manual-uso-pdf
          path: docs/manual-uso.pdf

  publish_release:
    name: Publicar Release con artifacts
    runs-on: ubuntu-latest
    needs: [build_frontend, build_docs]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download dist.zip
        uses: actions/download-artifact@v4
        with:
          name: dist-zip

      - name: Download manual-uso.pdf
        uses: actions/download-artifact@v4
        with:
          name: manual-uso-pdf

      - name: Publicar Release (tag push)
        if: ${{ github.event_name == 'push' }}
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist.zip
            docs/manual-uso.pdf
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publicar Release (trigger manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          files: |
            dist.zip
            docs/manual-uso.pdf
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}